# netty
## 线程模型基本介绍
### 目前存在的线程模型
- 传统阻塞I/O服务模型
- Reactor模型
### Reactor三剑客
- 单Reactor单线程
- 单Reactor多线程
- 主从Reactor多线程
### Netty线程模式
Netty 主要基于主从 Reactor 多线程模型做了一定的改进，其中主从 Reactor 多线程模型有多个 Reactor。
## 原理解析
通过图文并茂的方式对各个线程模型进行原理解剖，并且分析出每个模型的优缺点。
### 传统阻塞I/O服务模型
#### 架构图
```
                                        ----------------------------------------  
                                       |   应用程序                             |
                                       |  ------------------------------------  |
                                       | |   处理线程                         | |
                                       | |  --------------------------------  | |
     --------      request             | | |              handler           | | |
    | client | <-----------------------> | |  ------   ----------   ------  | | |
     --------      response            | | | | read | | 业务处理 | | send | | | |
                                       | | |  ------   ----------   ------  | | |
                                       | |  --------------------------------  | |
                                       |  ------------------------------------  |
                                       |                                        |
                                       |  ------------------------------------  |
                                       | |   处理线程                         | |
     --------      request             | |  --------------------------------  | |
    | client | <-----------------------> | |              handler           | | |
     --------      response            | | |  ------   ----------   ------  | | |
                                       | | | | read | | 业务处理 | | send | | | |
                                       | | |  ------   ----------   ------  | | |
                                       | |  --------------------------------  | |
                                       |  ------------------------------------  |
                                        ----------------------------------------

```
- 对象：client、handler
- API：read、业务处理、send
#### 模型特点
- 采用阻塞I/O模式获取输入的数据
- 需要为每个请求连接创建独立线程完成：读取数据、业务处理、数据返回
#### 优点
流程简单，易于实现
#### 缺点
- 当并发量大时，会创建大量的线程处理请求，占用很大的系统资源
- 线程创建后，如果当前线程暂时没有数据可读，该线程就会阻塞在read操作，造成线程资源浪费
#### 优化方案
- 基于I/O复用模型（Reactor）：多个连接共用一个阻塞对象，应用程序只需要在一个阻塞对象等待，无需阻塞等待所有连接。当某个连接有新的数据可以处理时，操作系统通知应用程序，线程从阻塞状态返回，开始进行业务处理 Reactor 对应的叫法:
  - 反应器模式 
  - 分发者模式(Dispatcher) 
  - 通知者模式(notifier)
- 基于线程池资源复用模型：不必再为每个连接创建线程，将连接完成后的业务处理任务分配给线程进行处理，一个线程可以处理多个连接的业务
#### I/O复用 + 线程池 = Reactor 模式基本设计思想
```
                                        ----------------------------------------  
                                       |   应用程序                             |
                                       |  ------------------------------------  |
                                       | |   处理线程                         | |
                                       | |  --------------------------------  | |
     --------      event               | | |              handler           | | |
    | client | <-------------          | | |  ------   ----------   ------  | | |
     --------                |         | | | | read | | 业务处理 | | send | | | |
                             |         | | |  ------   ----------   ------  | | |
                             |         | |  --------------------------------  | |
                             |         |  ------------------------------------  |
                             |         |                ^                       |
                             |         |                | dispatch              |
                             |         |     -----------------------            |
                             |         |    |  ServiceHandler       |           |
                             |------------> |   ---------------     |           |
                             |         |    |  | EventDispatch |    |           |
                             |         |    |   ---------------     |           |
                             |         |     -----------------------            |
                             |         |                | dispatch              |
                             |         |                V                       |
                             |         |  ------------------------------------  |
                             |         | |   处理线程                         | |
     --------      event     |         | |  --------------------------------  | |
    | client | <-------------          | | |              handler           | | |
     --------                          | | |  ------   ----------   ------  | | |
                                       | | | | read | | 业务处理 | | send | | | |
                                       | | |  ------   ----------   ------  | | |
                                       | |  --------------------------------  | |
                                       |  ------------------------------------  |
                                        ----------------------------------------

对象：client、ServiceHandler、EventHandler
API：EventDispatch、read、业务处理、send
```
- Reactor 模式，通过一个或多个输入同时传递给服务处理器的模式(基于事件驱动)
- 服务器端程序处理传入的多个请求,并将它们同步分派到相应的处理线程， 因此 Reactor 模式也叫 Dispatcher 模式
- Reactor 模式使用 IO 复用监听事件, 收到事件后，分发给某个线程(进程), 这点就是网络服务器高并发处理关键
### Reactor模式的核心组件
#### Reactor
Reactor 在一个单独的线程中运行，负责监听和分发事件，分发给适当的处理程序来对 IO 事件做出反应。类似于公司的行政前台，负责接待应聘者，并应聘者指引到具体的面试官。
#### Handlers
完成 I/O 事件处理的实际事件，类似于面试流程实际处理者的面试官。Reactor通过调度适当的 handler 处理 I/O 事件，处理程序执行非阻塞操作。
### Reactor模式分类
根据 Reactor 的数量和处理资源池线程的数量不同，有 3 种典型的实现
#### 单Reactor单线程
##### 原理图
```
                                            
                                                ---------------------------------------------------------
                                               |  应用程序                                               |
                                               |  -----------------------------------------------------  |
                                               | | 单线程                                              | |
         --------     request                  | |   -------------------------                         | |
        | client | --------------------        | |  |      Reactor            |                        | |
         --------                      |----------->|  --------   ----------  |                        | |
                                       |       | |  | | select | | dispatch | |                        | |
                                       |       | |  |  --------   ----------  |                        | |
                                       |       | |   -------------------------                         | |
                                       |       | |           |            |                            | |
                                       |       | |  建立连接  |            |  处理请求                  | |
                                       |       | |           V            V                            | | 
                                       |       | |   ------------    --------------------------------  | |
         --------     request          |       | |  |  Acceptor  |  |              Handler           | | |
        | client | --------------------        | |  |  --------  |  |  ------   ----------   ------  | | |
         --------                              | |  | | select | |  | | read | | 业务处理 | | send |  | | |
                                               | |  |  --------  |  |  ------   ----------   ------  | | |
                                               | |   ------------    --------------------------------  | |
                                               |  -----------------------------------------------------  |
                                                ---------------------------------------------------------

对象：client、Reactor、Acceptor、Handler
API：EventDispatch、read、业务处理、send
```
##### 方案说明
- Select 是前面 I/O 复用模型介绍的标准网络编程 API，可以实现应用程序通过一个阻塞对象监听多路连接请求
- Reactor 对象通过 Select 监控客户端请求事件，收到事件后通过 Dispatch 进行分发
- 如果是建立连接请求事件，则由 Acceptor 通过 Accept 处理连接请求，然后创建一个 Handler 对象处理连接完成后的后续业务处理
- 如果不是建立连接事件，则 Reactor 会直接分发调用连接对应的 Handler 来响应
- Handler 会完成 Read→业务处理→Send 的完整业务流程
##### 方案分析
- 优点：模型简单，没有多线程、进程通信、竞争的问题，全部都在一个线程中完成
- 缺点：性能问题，无法充分利用多核CPU性能，多客户端请求情况下，单线程容易产生阻塞等待；可靠性问题，线程意外终止或者进入死循环，则会导致整个系统不可用。
#### 单Reactor多线程
##### 原理图
```

                                            
                                                ---------------------------------------------------------
                                               |  应用程序                                               |
                                               |  -----------------------------------------------------  |
                                               | | 主线程                                              | |
         --------     request                  | |   -------------------------                         | |
        | client | --------------------        | |  |      Reactor            |                        | |
         --------                      |----------->|  --------   ----------  |                        | |
                                       |       | |  | | select | | dispatch | |                        | |
                                       |       | |  |  --------   ----------  |                        | |
                                       |       | |   -------------------------                         | |
                                       |       | |           |            |                            | |
                                       |       | |  建立连接  |            |  处理请求                  | |
                                       |       | |           V            V                            | | 
                                       |       | |   ------------    ------------    ------------      | |
         --------     request          |       | |  |  Acceptor  |  |  Handler   |  |  Handler   |     | |
        | client | --------------------        | |  |  --------  |  |  --------  |  |  --------  |     | |
         --------                              | |  | | select | |  | | handle | |  | | handle | |     | |
                                               | |  |  --------  |  |  --------  |  |  --------  |     | |
                                               | |   ------------    ------------    ------------      | |
                                               |  -------------------------|---------------|-----------  |
                                               |                           |               |             |
                                               |                           |               |             |
                                               |                -----------                |             |
                                               |  -------------|---------------------------|----------   |
                                               | |  线程池     V                           V          |  |
                                               | |     ------------------      ------------------     |  |
                                               | |    | 线程1            |    | 线程1            |    |  |
                                               | |    |  --------------  |    |  --------------  |    |  |
                                               | |    | |    Worker    | |    | |    Worker    | |    |  |
                                               | |    | |  ----------  | |    | |  ----------  | |    |  |
                                               | |    | | | 业务处理  | | |    | | | 业务处理 | | |    |  |
                                               | |    | |  ----------  | |    | |  ----------  | |    |  |
                                               | |    |  --------------  |    |  --------------  |    |  |
                                               | |     ------------------      ------------------     |  |
                                               |  ----------------------------------------------------   |
                                                ---------------------------------------------------------


对象：Client、Reactor、Acceptor、Handler、Worker
API：select、dispatch、accept、read、send、业务处理
```
##### 方案说明
- Reactor 对象通过 select 监控客户端请求事件, 收到事件后，通过 dispatch 进行分发
- 如果建立连接请求, 则右 Acceptor 通过 accept 处理连接请求, 然后创建一个 Handler 对象处理完成连接后的各种事件
- 如果不是连接请求，则由 reactor 分发调用连接对应的 handler 来处理
- handler 只负责响应事件，不做具体的业务处理, 通过 read 读取数据后，会分发给后面线程池的某个线程处理业务
- worker 线程池会分配独立线程完成真正的业务，并将结果返回给 handler
- handler 收到响应后，通过 send 将结果返回给 client
##### 方案分析
- 优点：可以充分的利用多核 CPU 的处理能力
- 缺点：多线程数据共享和访问比较复杂，主线程 reactor 处理所有的事件监听和响应，在高并发场景容易出现性能瓶颈。
#### 主从Reactor多线程
##### 原理图
```

                                            
                                                ---------------------------------------------------------
                                               |  应用程序                                               |
                                               |  -----------------------------------------------------  |
                                               | | 主线程                                              | |
         --------     request                  | |   -------------------------          ------------   | |
        | client | --------------------        | |  |       MainReactor       |        |  Acceptor  |  | |
         --------                      |----------->|  --------   ----------  |建立连接 |  --------  |  | |
                                       |       | |  | | select | | dispatch | | -----> | | accept | |  | |
                                       |       | |  |  --------   ----------  |        |  --------  |  | |
                                       |       | |   -------------------------          ------------   | |
                                       |       |  -------------------|---------------------------------  |
                                       |       |                     |                                   |
                                       |       |  -------------------|---------------------------------  | 
                                       |       | | Reactor 子线程    V                                 | |
                                       |       | |         ----------------------------                | |
                                       |       | |        |         SubReactor         |               | |
                                       |       | |        |   --------    ----------   |               | |
                                       |       | |        |  | select |  | dispatch |  |               | |
                                       |       | |        |   --------    ----------   |               | |
                                       |       | |         ----------------------------                | |
                                       |       | |            请求处理   |                             | |
                                       |       | |        ---------------------------------            | |
                                       |       | |        V               V               V            | |      
                                       |       | |   ------------    ------------    ------------      | |
         --------     request          |       | |  |  Handler1  |  |  Handler2  |  |  Handler3  |     | |
        | client | --------------------        | |  |  --------  |  |  --------  |  |  --------  |     | |
         --------                              | |  | | handle | |  | | handle | |  | | handle | |     | |
                                               | |  |  --------  |  |  --------  |  |  --------  |     | |
                                               | |   ------------    ------------    ------------      | |
                                               |  --------|----------------|---------------|-----------  |
                                               |          |                |               |             |
                                               |           ----------------|---------------              |
                                               |                           V                             |
                                               |  ----------------------------------------------------   |
                                               | |  线程池                                            |  |
                                               | |     ------------------      ------------------     |  |
                                               | |    | 线程1            |    | 线程2            |    |  |
                                               | |    |  --------------  |    |  --------------  |    |  |
                                               | |    | |    Worker    | |    | |    Worker    | |    |  |
                                               | |    | |  ----------  | |    | |  ----------  | |    |  |
                                               | |    | | | 业务处理  | | |    | | | 业务处理 | | |    |  |
                                               | |    | |  ----------  | |    | |  ----------  | |    |  |
                                               | |    |  --------------  |    |  --------------  |    |  |
                                               | |     ------------------      ------------------     |  |
                                               |  ----------------------------------------------------   |
                                                ---------------------------------------------------------


对象：Client、MainReactor、SubReactor、Acceptor、Handler、Worker
API：select、dispatch、accept、read、send、业务处理
```
